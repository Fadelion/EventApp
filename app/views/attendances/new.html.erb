<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card mt-4">
        <div class="card-header">
          <h2 class="mb-0">S'inscrire à l'événement</h2>
        </div>
        <div class="card-body">
          <div class="mb-4">
            <h4><%= @event.title %></h4>
            <p><strong>Date:</strong> <%= @event.start_date.strftime("%d/%m/%Y à %H:%M") %></p>
            <p><strong>Lieu:</strong> <%= @event.location %></p>
            <p><strong>Prix:</strong> <%= @event.price > 0 ? "#{@event.price}€" : "Gratuit" %></p>
          </div>
          
          <% if @event.price > 0 %>
            <div class="alert alert-info">
              <p>Pour vous inscrire à cet événement, vous devez payer <%= @event.price %>€.</p>
            </div>
            
            <%= form_with(url: event_attendances_path(@event), method: :post, id: "payment-form") do |f| %>
              <div class="mb-3">
                <label for="card-element" class="form-label">Carte de crédit</label>
                <div id="card-element" class="form-control" style="height: 2.4em; padding-top: .7em;"></div>
                <div id="card-errors" class="text-danger mt-2" role="alert"></div>
              </div>
              
              <div class="d-grid gap-2">
                <%= f.submit "Payer et s'inscrire", class: "btn btn-primary", id: "submit-button" %>
              </div>
            <% end %>
            
            <script src="https://js.stripe.com/v3/"></script>
            <script>
              document.addEventListener('DOMContentLoaded', function() {
                // Créer une instance de l'API Stripe
                var stripe = Stripe('<%= Rails.configuration.stripe[:publishable_key] %>');
                var elements = stripe.elements();
                
                // Créer un élément de carte et le monter au DOM
                var card = elements.create('card');
                card.mount('#card-element');
                
                // Gérer les erreurs de validation en temps réel
                card.addEventListener('change', function(event) {
                  var displayError = document.getElementById('card-errors');
                  if (event.error) {
                    displayError.textContent = event.error.message;
                  } else {
                    displayError.textContent = '';
                  }
                });
                
                // Gérer la soumission du formulaire
                var form = document.getElementById('payment-form');
                form.addEventListener('submit', function(event) {
                  event.preventDefault();
                  
                  // Désactiver le bouton pendant le traitement
                  document.getElementById('submit-button').disabled = true;
                  
                  // Créer un token et le soumettre au serveur
                  stripe.createToken(card).then(function(result) {
                    if (result.error) {
                      // Informer l'utilisateur s'il y a une erreur
                      var errorElement = document.getElementById('card-errors');
                      errorElement.textContent = result.error.message;
                      document.getElementById('submit-button').disabled = false;
                    } else {
                      // Envoyer le token au serveur
                      stripeTokenHandler(result.token);
                    }
                  });
                });
                
                function stripeTokenHandler(token) {
                  // Insérer le token ID dans le formulaire pour qu'il soit soumis au serveur
                  var form = document.getElementById('payment-form');
                  var hiddenInput = document.createElement('input');
                  hiddenInput.setAttribute('type', 'hidden');
                  hiddenInput.setAttribute('name', 'stripeToken');
                  hiddenInput.setAttribute('value', token.id);
                  form.appendChild(hiddenInput);
                  
                  // Soumettre le formulaire
                  form.submit();
                }
              });
            </script>
          <% else %>
            <!-- Pour les événements gratuits -->
            <%= form_with(url: event_attendances_path(@event), method: :post) do |f| %>
              <div class="alert alert-success">
                <p>Cet événement est gratuit. Cliquez sur le bouton ci-dessous pour vous inscrire.</p>
              </div>
              
              <div class="d-grid gap-2">
                <%= f.submit "S'inscrire gratuitement", class: "btn btn-success" %>
              </div>
            <% end %>
          <% end %>
          
          <div class="mt-3">
            <%= link_to "Retour à l'événement", event_path(@event), class: "btn btn-outline-secondary" %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
